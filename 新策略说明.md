# 新策略条件说明

## 📋 策略描述

该策略用于回测近 N 个**交易日**内符合条件的股票（不含周末），策略条件如下：

1. **T-5日涨停**：回测日期往前推5个交易日涨停
2. **T-4日涨幅>0**：回测日期往前推4个交易日涨幅大于零
3. **T-3日涨幅<0**：回测日期往前推3个交易日涨幅小于零
4. **T-4日成交量/T-3日成交量>1**：回测日期往前推4个交易日的成交量除以往前推3个交易日的成交量大于1
5. **T日成交量/T-3日成交量>1**：回测日期当天的成交量除以往前推3个交易日的成交量大于1
6. **T日涨幅>0**：回测日期当天涨幅大于零

其中 **T** 表示回测日期（比如1月12日），**T-5** 表示往前推5个交易日（比如1月07日）。

## 🔄 回测逻辑

系统会从最新的交易日开始，往前遍历近 N 个交易日内的每个交易日作为回测日期 T，检查是否符合所有条件（不含周末）。

例如：
- 如果回测日期是 **1月12日**，则检查：
  - 1月07日（T-5）是否涨停
  - 1月08日（T-4）涨幅是否>0
  - 1月09日（T-3）涨幅是否<0
  - 1月08日成交量/1月09日成交量是否>1
  - 1月12日成交量/1月09日成交量是否>1
  - 1月12日涨幅是否>0

- 如果回测日期是 **1月11日**，则检查：
  - 1月06日（T-5）是否涨停
  - 1月07日（T-4）涨幅是否>0
  - 1月08日（T-3）涨幅是否<0
  - 1月07日成交量/1月08日成交量是否>1
  - 1月11日成交量/1月08日成交量是否>1
  - 1月11日涨幅是否>0

以此类推，遍历所有可能的回测日期。

## 💻 使用方法

### 方法1：使用前端界面

1. 打开策略回测页面
2. 点击"加载示例策略"按钮，会自动填充所有条件
3. 点击"开始回测"按钮

### 方法2：手动配置

在前端界面中，添加以下6个条件：

1. **涨停条件**
   - 类型：涨停
   - 日期偏移：**-5**（负数表示往前推5个交易日）

2. **涨幅大于条件1**
   - 类型：涨幅大于
   - 日期偏移：**-4**
   - 值：**0**

3. **涨幅小于条件**
   - 类型：涨幅小于
   - 日期偏移：**-3**
   - 值：**0**

4. **成交量比例条件1**
   - 类型：成交量比例
   - 日期偏移：**-4**（分子）
   - 日期2偏移：**-3**（分母）
   - 比例：**1**

5. **成交量比例条件2**
   - 类型：成交量比例
   - 日期偏移：**0**（回测日期本身，分子）
   - 日期2偏移：**-3**（分母）
   - 比例：**1**

6. **涨幅大于条件2**
   - 类型：涨幅大于
   - 日期偏移：**0**（回测日期本身）
   - 值：**0**

### 方法3：使用API

```python
from strategy_engine import StrategyEngine
from data_fetcher import DataFetcher

fetcher = DataFetcher()
engine = StrategyEngine(fetcher, max_workers=20)

strategy = {
    'conditions': [
        {'type': 'limit_up', 'date1': -5},
        {'type': 'pct_change_gt', 'date1': -4, 'value': 0},
        {'type': 'pct_change_lt', 'date1': -3, 'value': 0},
        {'type': 'volume_ratio', 'date1': -4, 'date2': -3, 'ratio': 1},
        {'type': 'volume_ratio', 'date1': 0, 'date2': -3, 'ratio': 1},
        {'type': 'pct_change_gt', 'date1': 0, 'value': 0}
    ],
    'timeRange': 30
}

results = engine.backtest(strategy)
```

## 📝 日期偏移说明

- **负数**：表示往前推N个交易日
  - `-5` 表示往前推5个交易日
  - `-3` 表示往前推3个交易日
- **0**：表示回测日期本身
- **正数**：表示往后推N个交易日（本策略中不使用）

## ⚡ 性能优化

- 使用20个并发线程加速回测
- 从最新日期开始往前遍历，找到第一个符合条件的回测日期即返回
- 支持文件缓存，避免重复请求数据

## 🎯 返回结果

返回的结果包含：
- `code`: 股票代码
- `name`: 股票名称
- `match_date`: 符合条件的回测日期
- `current_price`: 当前价格（最新交易日收盘价）
- `match_price`: 回测日期当天的收盘价
